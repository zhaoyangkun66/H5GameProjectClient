let sendData = {
    "user_id": 213,
    "game_id": "487693",
    "start_time": 1733217861,
    "end_time": 1733217891,
    "state": 2,
    "timer": -1,
    "killer_room": 1,
    "pre_killer_room": 1,
    "join_people": 100,
    "max_people": 20,
    "total_killer_amount": "0.00",
    "user_bonus": 11,
    "user_amount": 22,
    "user_list": [
        {
            "user_id": 1877623996296466432,
            "nickname": "1***",
            "room_id": 8,
            "amount": 43,
            "dress": 0
        },
        {
            "user_id": 141,
            "nickname": "1***",
            "room_id": 4,
            "amount": 95,
            "dress": 0
        },
        {
            "user_id": 79,
            "nickname": "*",
            "room_id": 1,
            "amount": 52,
            "dress": 0
        },
        {
            "user_id": 89,
            "nickname": "1***",
            "room_id": 8,
            "amount": 36,
            "dress": 0
        },
        {
            "user_id": 68,
            "nickname": "*",
            "room_id": 1,
            "amount": 29,
            "dress": 0
        },
        {
            "user_id": 69,
            "nickname": "\u4fee**",
            "room_id": 6,
            "amount": 96,
            "dress": 0
        },
        {
            "user_id": 61,
            "nickname": "*",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 7,
            "nickname": "S***",
            "room_id": 7,
            "amount": 148,
            "dress": 0
        },
        {
            "user_id": 154,
            "nickname": "f***",
            "room_id": 6,
            "amount": 25,
            "dress": 0
        },
        {
            "user_id": 26,
            "nickname": "*",
            "room_id": 4,
            "amount": 51,
            "dress": 0
        },
        {
            "user_id": 139,
            "nickname": "1***",
            "room_id": 3,
            "amount": 52,
            "dress": 0
        },
        {
            "user_id": 22,
            "nickname": "a***",
            "room_id": 3,
            "amount": 87,
            "dress": 0
        },
        {
            "user_id": 136,
            "nickname": "1***",
            "room_id": 4,
            "amount": 81,
            "dress": 0
        },
        {
            "user_id": 135,
            "nickname": "1***",
            "room_id": 4,
            "amount": 14,
            "dress": 0
        },
        {
            "user_id": 149,
            "nickname": "3***",
            "room_id": 4,
            "amount": 96,
            "dress": 0
        },
        {
            "user_id": 125,
            "nickname": "1***",
            "room_id": 8,
            "amount": 56,
            "dress": 0
        },
        {
            "user_id": 157,
            "nickname": "b***",
            "room_id": 2,
            "amount": 44,
            "dress": 0
        },
        {
            "user_id": 129,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 25,
            "nickname": "*",
            "room_id": 8,
            "amount": 37,
            "dress": 0
        },
        {
            "user_id": 9,
            "nickname": "\u6f58**",
            "room_id": 1,
            "amount": 138,
            "dress": 0
        },
        {
            "user_id": 21,
            "nickname": "*",
            "room_id": 7,
            "amount": 87,
            "dress": 0
        },
        {
            "user_id": 81,
            "nickname": "C*",
            "room_id": 5,
            "amount": 98,
            "dress": 0
        },
        {
            "user_id": 78,
            "nickname": "\u5fc5**",
            "room_id": 2,
            "amount": 50,
            "dress": 0
        },
        {
            "user_id": 67,
            "nickname": "*",
            "room_id": 2,
            "amount": 85,
            "dress": 0
        },
        {
            "user_id": 147,
            "nickname": "3***",
            "room_id": 6,
            "amount": 54,
            "dress": 0
        },
        {
            "user_id": 80,
            "nickname": "*",
            "room_id": 6,
            "amount": 76,
            "dress": 0
        },
        {
            "user_id": 156,
            "nickname": "9***",
            "room_id": 8,
            "amount": 35,
            "dress": 0
        },
        {
            "user_id": 124,
            "nickname": "1***",
            "room_id": 5,
            "amount": 86,
            "dress": 0
        },
        {
            "user_id": 163,
            "nickname": "l***",
            "room_id": 4,
            "amount": 43,
            "dress": 0
        },
        {
            "user_id": 107,
            "nickname": "1***",
            "room_id": 8,
            "amount": 85,
            "dress": 0
        },
        {
            "user_id": 72,
            "nickname": "A***",
            "room_id": 2,
            "amount": 97,
            "dress": 0
        },
        {
            "user_id": 73,
            "nickname": "\u963f***",
            "room_id": 1,
            "amount": 87,
            "dress": 0
        },
        {
            "user_id": 118,
            "nickname": "1***",
            "room_id": 1,
            "amount": 69,
            "dress": 0
        },
        {
            "user_id": 98,
            "nickname": "1***",
            "room_id": 4,
            "amount": 18,
            "dress": 0
        },
        {
            "user_id": 160,
            "nickname": "1***",
            "room_id": 5,
            "amount": 30,
            "dress": 0
        },
        {
            "user_id": 60,
            "nickname": "\u5c0f**",
            "room_id": 6,
            "amount": 63,
            "dress": 0
        },
        {
            "user_id": 62,
            "nickname": "*",
            "room_id": 6,
            "amount": 19,
            "dress": 0
        },
        {
            "user_id": 120,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 105,
            "nickname": "1***",
            "room_id": 1,
            "amount": 97,
            "dress": 0
        },
        {
            "user_id": 117,
            "nickname": "1***",
            "room_id": 6,
            "amount": 39,
            "dress": 0
        },
        {
            "user_id": 140,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 8,
            "nickname": "*",
            "room_id": 5,
            "amount": 184,
            "dress": 0
        },
        {
            "user_id": 27,
            "nickname": "*",
            "room_id": 7,
            "amount": 96,
            "dress": 0
        },
        {
            "user_id": 151,
            "nickname": "1***",
            "room_id": 4,
            "amount": 30,
            "dress": 0
        },
        {
            "user_id": 74,
            "nickname": "*",
            "room_id": 1,
            "amount": 22,
            "dress": 0
        },
        {
            "user_id": 131,
            "nickname": "1***",
            "room_id": 7,
            "amount": 33,
            "dress": 0
        },
        {
            "user_id": 158,
            "nickname": "4***",
            "room_id": 8,
            "amount": 57,
            "dress": 0
        },
        {
            "user_id": 113,
            "nickname": "1***",
            "room_id": 6,
            "amount": 34,
            "dress": 0
        },
        {
            "user_id": 155,
            "nickname": "W***",
            "room_id": 2,
            "amount": 43,
            "dress": 0
        },
        {
            "user_id": 1,
            "nickname": "\u54d1**",
            "room_id": 8,
            "amount": 111,
            "dress": 0
        },
        {
            "user_id": 112,
            "nickname": "1***",
            "room_id": 2,
            "amount": 14,
            "dress": 0
        },
        {
            "user_id": 213,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 17,
            "nickname": "\u3164***",
            "room_id": 4,
            "amount": 84,
            "dress": 0
        },
        {
            "user_id": 76,
            "nickname": "*",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 127,
            "nickname": "1***",
            "room_id": 1,
            "amount": 30,
            "dress": 0
        },
        {
            "user_id": 130,
            "nickname": "1***",
            "room_id": 8,
            "amount": 63,
            "dress": 0
        },
        {
            "user_id": 121,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 3,
            "nickname": "\u6587*",
            "room_id": 6,
            "amount": 73,
            "dress": 0
        },
        {
            "user_id": 14,
            "nickname": "*",
            "room_id": 2,
            "amount": 59,
            "dress": 0
        },
        {
            "user_id": 128,
            "nickname": "1***",
            "room_id": 5,
            "amount": 32,
            "dress": 0
        },
        {
            "user_id": 137,
            "nickname": "1***",
            "room_id": 4,
            "amount": 48,
            "dress": 0
        },
        {
            "user_id": 10,
            "nickname": "\u8f9b**",
            "room_id": 3,
            "amount": 145,
            "dress": 0
        },
        {
            "user_id": 92,
            "nickname": "1***",
            "room_id": 5,
            "amount": 16,
            "dress": 0
        },
        {
            "user_id": 83,
            "nickname": "\u6708***",
            "room_id": 1,
            "amount": 94,
            "dress": 0
        },
        {
            "user_id": 85,
            "nickname": "*",
            "room_id": 3,
            "amount": 44,
            "dress": 0
        },
        {
            "user_id": 104,
            "nickname": "1***",
            "room_id": 6,
            "amount": 99,
            "dress": 0
        },
        {
            "user_id": 71,
            "nickname": "M***",
            "room_id": 5,
            "amount": 23,
            "dress": 0
        },
        {
            "user_id": 144,
            "nickname": "1***",
            "room_id": 2,
            "amount": 33,
            "dress": 0
        },
        {
            "user_id": 109,
            "nickname": "1***",
            "room_id": 1,
            "amount": 28,
            "dress": 0
        },
        {
            "user_id": 122,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 5,
            "nickname": "*",
            "room_id": 8,
            "amount": 46,
            "dress": 0
        },
        {
            "user_id": 146,
            "nickname": "\u6d4b***",
            "room_id": 4,
            "amount": 68,
            "dress": 0
        },
        {
            "user_id": 75,
            "nickname": "*",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 20,
            "nickname": "*",
            "room_id": 6,
            "amount": 162,
            "dress": 0
        },
        {
            "user_id": 24,
            "nickname": "*",
            "room_id": 6,
            "amount": 70,
            "dress": 0
        },
        {
            "user_id": 64,
            "nickname": "\u7a7f***",
            "room_id": 5,
            "amount": 55,
            "dress": 0
        },
        {
            "user_id": 19,
            "nickname": "@*",
            "room_id": 1,
            "amount": 110,
            "dress": 0
        },
        {
            "user_id": 110,
            "nickname": "1***",
            "room_id": 6,
            "amount": 26,
            "dress": 0
        },
        {
            "user_id": 138,
            "nickname": "9***",
            "room_id": 1,
            "amount": 76,
            "dress": 0
        },
        {
            "user_id": 77,
            "nickname": "*",
            "room_id": 4,
            "amount": 61,
            "dress": 0
        },
        {
            "user_id": 159,
            "nickname": "1***",
            "room_id": 7,
            "amount": 85,
            "dress": 0
        },
        {
            "user_id": 111,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 106,
            "nickname": "1***",
            "room_id": 3,
            "amount": 75,
            "dress": 0
        },
        {
            "user_id": 133,
            "nickname": "1***",
            "room_id": 4,
            "amount": 25,
            "dress": 0
        },
        {
            "user_id": 150,
            "nickname": "2***",
            "room_id": 8,
            "amount": 34,
            "dress": 0
        },
        {
            "user_id": 28,
            "nickname": "*",
            "room_id": 2,
            "amount": 73,
            "dress": 0
        },
        {
            "user_id": 116,
            "nickname": "1***",
            "room_id": 7,
            "amount": 57,
            "dress": 0
        },
        {
            "user_id": 115,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 63,
            "nickname": "*",
            "room_id": 5,
            "amount": 81,
            "dress": 0
        },
        {
            "user_id": 161,
            "nickname": "1***",
            "room_id": 0,
            "amount": 0,
            "dress": 0
        },
        {
            "user_id": 153,
            "nickname": "5***",
            "room_id": 4,
            "amount": 73,
            "dress": 0
        },
        {
            "user_id": 82,
            "nickname": "\u8001***",
            "room_id": 8,
            "amount": 52,
            "dress": 0
        },
        {
            "user_id": 142,
            "nickname": "1***",
            "room_id": 1,
            "amount": 42,
            "dress": 0
        },
        {
            "user_id": 11,
            "nickname": "*",
            "room_id": 4,
            "amount": 97,
            "dress": 0
        },
        {
            "user_id": 162,
            "nickname": "c***",
            "room_id": 4,
            "amount": 77,
            "dress": 0
        },
        {
            "user_id": 65,
            "nickname": "*",
            "room_id": 5,
            "amount": 27,
            "dress": 0
        },
        {
            "user_id": 119,
            "nickname": "1***",
            "room_id": 4,
            "amount": 80,
            "dress": 0
        },
        {
            "user_id": 23,
            "nickname": "*",
            "room_id": 5,
            "amount": 18,
            "dress": 0
        },
        {
            "user_id": 4,
            "nickname": "\u84dd***",
            "room_id": 2,
            "amount": 136,
            "dress": 0
        },
        {
            "user_id": 91,
            "nickname": "1***",
            "room_id": 4,
            "amount": 32,
            "dress": 0
        },
        {
            "user_id": 86,
            "nickname": "L***",
            "room_id": 3,
            "amount": 42,
            "dress": 0
        },
        {
            "user_id": 152,
            "nickname": "2***",
            "room_id": 2,
            "amount": 75,
            "dress": 0
        },
        {
            "user_id": 96,
            "nickname": "1***",
            "room_id": 4,
            "amount": 24,
            "dress": 0
        },
        {
            "user_id": 114,
            "nickname": "1***",
            "room_id": 3,
            "amount": 83,
            "dress": 0
        },
        {
            "user_id": 103,
            "nickname": "1***",
            "room_id": 7,
            "amount": 66,
            "dress": 0
        },
        {
            "user_id": 108,
            "nickname": "1***",
            "room_id": 6,
            "amount": 26,
            "dress": 0
        },
        {
            "user_id": 12,
            "nickname": "\u7834***",
            "room_id": 4,
            "amount": 28,
            "dress": 0
        },
        {
            "user_id": 66,
            "nickname": "*",
            "room_id": 5,
            "amount": 51,
            "dress": 0
        },
        {
            "user_id": 90,
            "nickname": "1***",
            "room_id": 7,
            "amount": 81,
            "dress": 0
        },
        {
            "user_id": 143,
            "nickname": "1***",
            "room_id": 6,
            "amount": 79,
            "dress": 0
        },
        {
            "user_id": 123,
            "nickname": "1***",
            "room_id": 6,
            "amount": 86,
            "dress": 0
        },
        {
            "user_id": 15,
            "nickname": "*",
            "room_id": 1,
            "amount": 143,
            "dress": 0
        }
    ],
    "room_list": [
        {
            "room_id": 1,
            "amount": 1017,
            "count": 14
        },
        {
            "room_id": 2,
            "amount": 709,
            "count": 11
        },
        {
            "room_id": 3,
            "amount": 528,
            "count": 7
        },
        {
            "room_id": 4,
            "amount": 1125,
            "count": 20
        },
        {
            "room_id": 5,
            "amount": 701,
            "count": 12
        },
        {
            "room_id": 6,
            "amount": 1027,
            "count": 16
        },
        {
            "room_id": 7,
            "amount": 653,
            "count": 8
        },
        {
            "room_id": 8,
            "amount": 655,
            "count": 12
        }
    ],
    "timestamp": 1733217872
}
let initGame = {
    "code": 200,
    "msg": "获取成功",
    "data": {
        "balance": "9794087.57",
        "game_id": 488865,
        "pre_killer_room": 2
    }
}
let join = { "code": 200, "msg": "操作成功" }

function mergeArrayBuffers(arrayBuffers) {
    let totalLength = 0;
    for (let i = 0; i < arrayBuffers.length; i++) {
        totalLength += arrayBuffers[i].byteLength;
    }

    let mergedBuffer = new ArrayBuffer(totalLength);
    let mergedView = new Uint8Array(mergedBuffer);

    let offset = 0;
    for (let i = 0; i < arrayBuffers.length; i++) {
        let arrayBuffer = arrayBuffers[i];
        let view = new Uint8Array(arrayBuffer);
        mergedView.set(view, offset);
        offset += view.byteLength;
    }

    return mergedBuffer;
}

const WebSocket = require('ws');

// 创建WebSocket服务器监听端口3000
const wss = new WebSocket.Server({ port: 9016 });


let state = 1;
let timer = 40;
wss.on('connection', function connection(ws) {
    // 当客户端连接时，打印一条消息
    console.log('connected');

    // 当接收到客户端消息时，打印出来并将其返回给客户端
    ws.on('message', function incoming(message) {
        console.log('received:', message);
        // ws.send(message, (err) => {
        //     if (err) {
        //         console.log('error: %s', err);
        //     }
        // });
        var buf = new Uint8Array(message, 0);
        var len = (buf[0] << 24) + (buf[1] << 16) + (buf[2] << 8) + buf[3];
        console.log('received:len', len);
        if (len == 7) {
            let encoder = new TextEncoder();
            let view3 = encoder.encode(JSON.stringify(join));
            const buffer1 = new ArrayBuffer(4);
            const view1 = new DataView(buffer1);
            view1.setInt32(0, 8, false);
            const buffer2 = new ArrayBuffer(4);
            const view2 = new DataView(buffer2);
            view2.setInt32(0, view3.byteLength, false);
            // 发送欢迎消息给客户端
            ws.send(mergeArrayBuffers([view1.buffer, view2.buffer, view3.buffer]));
        }
    });

    // 当连接关闭时，打印一条消息
    ws.on('close', function close() {
        console.log('disconnected');
    });
    setInterval(() => {
        timer--
        if (timer < 0) {
            timer = 20
            state++
        }
        if (state > 3) {
            state = 1
        }
        sendData.state = state
        sendData.timer = timer
        let encoder = new TextEncoder();
        let view3 = encoder.encode(JSON.stringify(sendData));
        const buffer1 = new ArrayBuffer(4);
        const view1 = new DataView(buffer1);
        view1.setInt32(0, 12, false);
        const buffer2 = new ArrayBuffer(4);
        const view2 = new DataView(buffer2);
        view2.setInt32(0, view3.byteLength, false);
        // 发送欢迎消息给客户端
        ws.send(mergeArrayBuffers([view1.buffer, view2.buffer, view3.buffer]));
        console.log('这条信息每秒发送一次');
        {
            let encoder = new TextEncoder();
            let view3 = encoder.encode(JSON.stringify(initGame));
            const buffer1 = new ArrayBuffer(4);
            const view1 = new DataView(buffer1);
            view1.setInt32(0, 10, false);
            const buffer2 = new ArrayBuffer(4);
            const view2 = new DataView(buffer2);
            view2.setInt32(0, view3.byteLength, false);
            // 发送欢迎消息给客户端
            ws.send(mergeArrayBuffers([view1.buffer, view2.buffer, view3.buffer]));
        }
    }, 1000);
    //   let encoder = new TextEncoder();
    //   let view3 = encoder.encode(JSON.stringify(data));
    //   const buffer1 = new ArrayBuffer(4);
    //   const view1 = new DataView(buffer1);
    //   view1.setInt32(0, msgid, false);
    //   const buffer2 = new ArrayBuffer(4);
    //   const view2 = new DataView(buffer2);
    //   view2.setInt32(0, view3.byteLength, false);
    //   // 发送欢迎消息给客户端
    //   ws.send(mergeArrayBuffers([view1.buffer, view2.buffer, view3.buffer]));
});

console.log('WebSocket server is running on ws');
